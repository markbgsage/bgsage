#include "bgbot/pubeval.h"
#include "bgbot/board.h"
#include <cstring>

namespace bgbot {

// Tesauro's original published weights
static constexpr double CONTACT_TESAURO[122] = {
     0.25696, -0.66937, -1.66135, -2.02487, -2.53398, -0.16092, -1.11725, -1.06654, -0.92830,
    -1.99558, -1.10388, -0.80802,  0.09856, -0.62086, -1.27999, -0.59220, -0.73667,  0.89032,
    -0.38933, -1.59847, -1.50197, -0.60966,  1.56166, -0.47389, -1.80390, -0.83425, -0.97741,
    -1.41371,  0.24500,  0.10970, -1.36476, -1.05572,  1.15420,  0.11069, -0.38319, -0.74816,
    -0.59244,  0.81116, -0.39511,  0.11424, -0.73169, -0.56074,  1.09792,  0.15977,  0.13786,
    -1.18435, -0.43363,  1.06169, -0.21329,  0.04798, -0.94373, -0.22982,  1.22737, -0.13099,
    -0.06295, -0.75882, -0.13658,  1.78389,  0.30416,  0.36797, -0.69851,  0.13003,  1.23070,
     0.40868, -0.21081, -0.64073,  0.31061,  1.59554,  0.65718,  0.25429, -0.80789,  0.08240,
     1.78964,  0.54304,  0.41174, -1.06161,  0.07851,  2.01451,  0.49786,  0.91936, -0.90750,
     0.05941,  1.83120,  0.58722,  1.28777, -0.83711, -0.33248,  2.64983,  0.52698,  0.82132,
    -0.58897, -1.18223,  3.35809,  0.62017,  0.57353, -0.07276, -0.36214,  4.37655,  0.45481,
     0.21746,  0.10504, -0.61977,  3.54001,  0.04612, -0.18108,  0.63211, -0.87046,  2.47673,
    -0.48016, -1.27157,  0.86505, -1.11342,  1.24612, -0.82385, -2.77082,  1.23606, -1.59529,
     0.10438, -1.30206, -4.11520,  5.62596, -2.75800
};

static constexpr double RACE_TESAURO[122] = {
     0.00000, -0.17160,  0.27010,  0.29906, -0.08471,  0.00000, -1.40375, -1.05121,  0.07217,
    -0.01351,  0.00000, -1.29506, -2.16183,  0.13246, -1.03508,  0.00000, -2.29847, -2.34631,
     0.17253,  0.08302,  0.00000, -1.27266, -2.87401, -0.07456, -0.34240,  0.00000, -1.34640,
    -2.46556, -0.13022, -0.01591,  0.00000,  0.27448,  0.60015,  0.48302,  0.25236,  0.00000,
     0.39521,  0.68178,  0.05281,  0.09266,  0.00000,  0.24855, -0.06844, -0.37646,  0.05685,
     0.00000,  0.17405,  0.00430,  0.74427,  0.00576,  0.00000,  0.12392,  0.31202, -0.91035,
    -0.16270,  0.00000,  0.01418, -0.10839, -0.02781, -0.88035,  0.00000,  1.07274,  2.00366,
     1.16242,  0.22520,  0.00000,  0.85631,  1.06349,  1.49549,  0.18966,  0.00000,  0.37183,
    -0.50352, -0.14818,  0.12039,  0.00000,  0.13681,  0.13978,  1.11245, -0.12707,  0.00000,
    -0.22082,  0.20178, -0.06285, -0.52728,  0.00000, -0.13597, -0.19412, -0.09308, -1.26062,
     0.00000,  3.05454,  5.16874,  1.50680,  5.35000,  0.00000,  2.19605,  3.85390,  0.88296,
     2.30052,  0.00000,  0.92321,  1.08744, -0.11696, -0.78560,  0.00000, -0.09795, -0.83050,
    -1.09167, -4.94251,  0.00000, -1.00316, -3.66465, -2.56906, -9.67677,  0.00000, -2.77982,
    -7.26713, -3.40177,-12.32250,  0.00000,  3.42040
};

// ListNet-retrained weights
static constexpr double CONTACT_LISTNET[122] = {
     0.012447, -0.151818, -0.297470, -0.186109, -0.736230, -0.010739, -0.157101, -0.249134, -0.149832,
    -0.596373, -0.035001, -0.132509, -0.177952, -0.128616, -0.553694, -0.075265, -0.125214, -0.132891,
    -0.115400, -0.479202, -0.117492, -0.117583, -0.105439, -0.097630, -0.446199, -0.226630, -0.115527,
    -0.109997, -0.110788, -0.716081, -0.184478, -0.116056, -0.080808, -0.061079, -0.280965, -0.152213,
    -0.080374, -0.091886, -0.066352, -0.215243, -0.134196, -0.082289, -0.055206, -0.034709, -0.218164,
    -0.123071, -0.077283, -0.043441, -0.031342, -0.253675, -0.090163, -0.072915, -0.032969, -0.027403,
    -0.068811, -0.134465, -0.053575, -0.016096, -0.020378, -0.108715, -0.082155, -0.038293, -0.016759,
    -0.041120, -0.067220, -0.057751, -0.035467,  0.000998, -0.008680, -0.014472, -0.009810, -0.033182,
     0.026207,  0.000654, -0.034510, -0.027354, -0.031002,  0.045999,  0.001958, -0.011467, -0.079906,
    -0.026607,  0.052087, -0.003273, -0.015277, -0.000027, -0.037944,  0.077124, -0.004370, -0.035115,
    -0.007780, -0.114402,  0.114096,  0.006308, -0.005267,  0.047548, -0.051251,  0.160729,  0.008508,
     0.001710,  0.094616, -0.023667,  0.137438, -0.004299, -0.009044,  0.120770, -0.024139,  0.114400,
    -0.009415, -0.049400,  0.131239, -0.035769,  0.086966, -0.033251, -0.129276,  0.156875, -0.035191,
     0.060863, -0.041009, -0.164081,  0.385500, -0.742681
};

static constexpr double RACE_LISTNET[122] = {
    -0.060000,  0.060000,  0.094000, -0.037000,  0.039000,  0.076000, -0.398822, -0.651534, -0.252295,
    -0.881730,  0.076000, -0.262855, -0.516324, -0.247976, -0.860779,  0.039000, -0.219300, -0.440971,
    -0.223653, -0.803437,  0.050000, -0.193286, -0.383928, -0.197875, -0.721095, -0.079000, -0.184218,
    -0.366563, -0.203616, -0.947985, -0.073000, -0.134738, -0.259017, -0.114073, -0.415172, -0.001000,
    -0.125476, -0.221667, -0.072814, -0.121289,  0.040000, -0.116535, -0.222040, -0.083004, -0.275122,
    -0.089000, -0.107453, -0.211692, -0.087019, -0.353833,  0.017000, -0.097997, -0.190342, -0.081816,
    -0.158724, -0.020000, -0.088336, -0.179094, -0.081762, -0.270055,  0.045000, -0.069946, -0.143084,
    -0.069716, -0.247550, -0.045000, -0.059525, -0.119608, -0.061901, -0.223778,  0.024000, -0.047485,
    -0.099523, -0.052359, -0.196490, -0.017000, -0.038993, -0.084336, -0.043083, -0.166478,  0.024000,
    -0.032074, -0.073071, -0.034276, -0.126206,  0.082000, -0.030739, -0.067925, -0.031622, -0.118992,
     0.100000,  0.017345,  0.025988,  0.002115,  0.003314, -0.086000,  0.015091,  0.026086,  0.005036,
     0.009792, -0.075000,  0.012400,  0.022128,  0.006218,  0.010388,  0.072000,  0.012389,  0.017524,
    -0.000478, -0.005448, -0.043000,  0.010968,  0.013205, -0.003821, -0.020889,  0.060000,  0.014303,
     0.008269, -0.014379, -0.045499,  0.050000,  0.683018
};

PubEval::PubEval(WeightSource src) {
    const double* wc;
    const double* wr;
    if (src == WeightSource::TESAURO) {
        wc = CONTACT_TESAURO;
        wr = RACE_TESAURO;
    } else {
        wc = CONTACT_LISTNET;
        wr = RACE_LISTNET;
    }
    std::copy(wc, wc + 122, weights_contact_.begin());
    std::copy(wr, wr + 122, weights_race_.begin());
}

void PubEval::compute_inputs(const Board& board, double* inputs) const {
    // Zero out
    std::memset(inputs, 0, 122 * sizeof(double));

    // PubEval indexes points from 24 down to 1 (i.e., pubeval point 0 = our point 24)
    for (int i = 0; i < 24; ++i) {
        int n = board[24 - i]; // our board point 24, 23, ... 1
        if (n == 0) continue;
        if (n == -1)         inputs[5 * i]     = 1.0;
        if (n == 1)          inputs[5 * i + 1] = 1.0;
        if (n >= 2)          inputs[5 * i + 2] = 1.0;
        if (n == 3)          inputs[5 * i + 3] = 1.0;
        if (n >= 4)          inputs[5 * i + 4] = (n - 3) / 2.0;
    }

    inputs[120] = board[0] / 2.0;            // opponent checkers on bar / 2
    inputs[121] = player_borne_off(board) / 15.0; // player checkers borne off / 15
}

double PubEval::evaluate(const Board& board, bool pre_move_is_race) const {
    // Handle terminal positions
    int p1_off = player_borne_off(board);
    int p2_off = opponent_borne_off(board);

    if (p1_off == 15) {
        return (p2_off == 0) ? 2.0 : 1.0;  // gammon or single win
    }
    if (p2_off == 15) {
        return (p1_off == 0) ? -2.0 : -1.0; // gammon or single loss
    }

    double inputs[122];
    compute_inputs(board, inputs);

    const auto& w = pre_move_is_race ? weights_race_ : weights_contact_;

    double val = 0.0;
    for (int i = 0; i < 122; ++i) {
        val += w[i] * inputs[i];
    }
    return val;
}

} // namespace bgbot
